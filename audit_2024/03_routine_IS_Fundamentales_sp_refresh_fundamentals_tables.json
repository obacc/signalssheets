{
  "etag": "0141Hu/waTZm8b452VhkYQ==",
  "routineReference": {
    "projectId": "sunny-advantage-471523-b3",
    "datasetId": "IS_Fundamentales",
    "routineId": "sp_refresh_fundamentals_tables"
  },
  "routineType": "PROCEDURE",
  "creationTime": "1765566068937",
  "lastModifiedTime": "1765566068937",
  "language": "SQL",
  "definitionBody": "BEGIN\n  /*\n  ============================================================================\n  SP: sp_refresh_fundamentals_tables\n  Prop\u00f3sito: Normalizar datos SEC \u2192 fundamentals_timeseries + fundamentals_ratios\n  Autor: Aaron / Indicium Signals\n  Fecha: 02 diciembre 2025\n  ============================================================================\n  \n  Proceso:\n  1. Extrae datos de Num/Sub/Tag con mapeo CIK\u2192Ticker\n  2. Pivotea tags SEC a columnas normalizadas\n  3. Calcula Q4 impl\u00edcito donde falta\n  4. Inserta a fundamentals_timeseries\n  5. Calcula ratios \u2192 fundamentals_ratios\n  \n  Idempotencia: TRUNCATE + INSERT (reemplaza todo)\n  Duraci\u00f3n: ~5-10 min para 43 quarters\n  ============================================================================\n  */\n  \n  DECLARE last_refresh_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP();\n  \n  -- Log inicio\n  SELECT CONCAT('\u2705 Iniciando refresh fundamentals: ', CAST(last_refresh_time AS STRING)) as log_message;\n  \n  -- =========================================================================\n  -- CTE 1: BASE DATA - Combinar Sub + Num + Mapping\n  -- =========================================================================\n  \n  CREATE TEMP TABLE base_data AS\n  SELECT \n    -- Identity\n    m.ticker,\n    s.cik,\n    m.company_name,\n    \n    -- Period info\n    s.fy as fiscal_year,\n    s.fp as fiscal_period,\n    PARSE_DATE('%Y%m%d', CAST(s.period AS STRING)) as period_end_date,\n    s.fye as fiscal_year_end_mmdd,\n    \n    -- Determine period type\n    CASE \n      WHEN s.fp IN ('Q1', 'Q2', 'Q3') THEN 'quarterly'\n      WHEN s.fp = 'FY' THEN 'annual'\n      ELSE 'other'\n    END as period_type,\n    \n    -- Filing metadata\n    s.form as form_type,\n    s.filed_date as filing_date,\n    s.adsh,\n    \n    -- Numeric values (pivot happens later)\n    n.tag,\n    n.version,\n    n.qtrs,\n    n.value,\n    n.ddate,\n    s.period as period_yyyymmdd  -- Agregar period para comparar con ddate\n    \n  FROM `sunny-advantage-471523-b3.IS_Fundamentales.Sub` s\n  INNER JOIN `sunny-advantage-471523-b3.IS_Fundamentales.cik_ticker_mapping` m ON s.cik = m.cik\n  INNER JOIN `sunny-advantage-471523-b3.IS_Fundamentales.Num` n ON s.adsh = n.adsh\n  WHERE \n    s.form IN ('10-Q', '10-K')  -- Solo quarterly y annual reports\n    AND m.is_active = TRUE  -- Solo tickers activos\n    AND n.value IS NOT NULL  -- Ignorar nulls\n    AND s.fy >= 2015  -- Desde 2015 en adelante\n  ;\n  \n  SELECT COUNT(*) as base_data_rows FROM base_data;\n  \n  -- =========================================================================\n  -- CTE 2: PIVOT INCOME STATEMENT TAGS\n  -- =========================================================================\n  \n  CREATE TEMP TABLE income_statement_pivot AS\n  SELECT\n    ticker,\n    cik,\n    company_name,\n    fiscal_year,\n    fiscal_period,\n    period_end_date,\n    fiscal_year_end_mmdd,\n    period_type,\n    form_type,\n    MAX(filing_date) as filing_date,  -- CORRECCI\u00d3N #2: Agregar MAX para filing_date\n    MAX(adsh) as adsh,  -- CORRECCI\u00d3N #2: Agregar MAX para adsh (solo para referencia)\n    \n    -- Income Statement fields (buscar tags m\u00e1s comunes)\n    MAX(CASE WHEN tag IN ('Revenues', 'RevenueFromContractWithCustomerExcludingAssessedTax', 'SalesRevenueNet') THEN value END) as revenues,\n    MAX(CASE WHEN tag IN ('CostOfRevenue', 'CostOfGoodsAndServicesSold') THEN value END) as cost_of_revenue,\n    MAX(CASE WHEN tag = 'GrossProfit' THEN value END) as gross_profit,\n    MAX(CASE WHEN tag IN ('OperatingExpenses', 'OperatingCostsAndExpenses') THEN value END) as operating_expenses,\n    MAX(CASE WHEN tag IN ('ResearchAndDevelopmentExpense', 'ResearchAndDevelopmentExpenseExcludingAcquiredInProcessCost') THEN value END) as research_development,\n    MAX(CASE WHEN tag IN ('SellingGeneralAndAdministrativeExpense', 'GeneralAndAdministrativeExpense') THEN value END) as selling_general_admin,\n    MAX(CASE WHEN tag IN ('OperatingIncomeLoss', 'OperatingIncome') THEN value END) as operating_income,\n    MAX(CASE WHEN tag IN ('InterestExpense', 'InterestExpenseDebt') THEN value END) as interest_expense,\n    MAX(CASE WHEN tag IN ('InterestIncomeExpenseNet', 'InterestAndDividendIncomeOperating') THEN value END) as interest_income,\n    MAX(CASE WHEN tag IN ('OtherNonoperatingIncomeExpense', 'NonoperatingIncomeExpense') THEN value END) as other_income_expense,\n    MAX(CASE WHEN tag = 'IncomeLossFromContinuingOperationsBeforeIncomeTaxesExtraordinaryItemsNoncontrollingInterest' THEN value END) as income_before_tax,\n    MAX(CASE WHEN tag IN ('IncomeTaxExpenseBenefit', 'IncomeTaxesPaid') THEN value END) as income_tax_expense,\n    MAX(CASE WHEN tag IN ('NetIncomeLoss', 'ProfitLoss') THEN value END) as net_income,\n    \n    -- EPS\n    MAX(CASE WHEN tag = 'EarningsPerShareBasic' THEN value END) as eps_basic,\n    MAX(CASE WHEN tag = 'EarningsPerShareDiluted' THEN value END) as eps_diluted,\n    MAX(CASE WHEN tag = 'WeightedAverageNumberOfSharesOutstandingBasic' THEN value END) as shares_outstanding_basic,\n    MAX(CASE WHEN tag = 'WeightedAverageNumberOfDilutedSharesOutstanding' THEN value END) as shares_outstanding_diluted\n    \n  FROM base_data\n  WHERE qtrs IN (1, 4)  -- CORRECCI\u00d3N #1: Solo quarterly (1) y annual (4) para IS, NO qtrs=0 (BS)\n  GROUP BY ticker, cik, company_name, fiscal_year, fiscal_period, period_end_date, \n           fiscal_year_end_mmdd, period_type, form_type  -- CORRECCI\u00d3N #2: Eliminado adsh y filing_date\n  ;\n  \n  SELECT COUNT(*) as income_statement_pivot_rows FROM income_statement_pivot;\n  \n  -- =========================================================================\n  -- CTE 3: PIVOT BALANCE SHEET TAGS\n  -- =========================================================================\n  \n  CREATE TEMP TABLE balance_sheet_pivot AS\n  SELECT\n    ticker,\n    cik,\n    fiscal_year,\n    fiscal_period,\n    period_end_date,\n    MAX(adsh) as adsh,  -- CORRECCI\u00d3N: Seleccionar el adsh m\u00e1s reciente\n    MAX(filing_date) as filing_date,  -- CORRECCI\u00d3N: Agregar filing_date para referencia\n    \n    -- Balance Sheet fields - CORRECCI\u00d3N CR\u00cdTICA: Filtro ddate = period_yyyymmdd para evitar valores de FY pegados a quarters\n    MAX(CASE WHEN tag = 'Assets' AND ddate = period_yyyymmdd THEN value END) as assets,\n    MAX(CASE WHEN tag = 'AssetsCurrent' AND ddate = period_yyyymmdd THEN value END) as current_assets,\n    MAX(CASE WHEN tag IN ('CashAndCashEquivalentsAtCarryingValue', 'Cash') AND ddate = period_yyyymmdd THEN value END) as cash_and_equivalents,\n    MAX(CASE WHEN tag IN ('ShortTermInvestments', 'AvailableForSaleSecuritiesCurrent') AND ddate = period_yyyymmdd THEN value END) as short_term_investments,\n    MAX(CASE WHEN tag IN ('AccountsReceivableNetCurrent', 'AccountsReceivableNet') AND ddate = period_yyyymmdd THEN value END) as accounts_receivable,\n    MAX(CASE WHEN tag IN ('InventoryNet', 'Inventory') AND ddate = period_yyyymmdd THEN value END) as inventory,\n    MAX(CASE WHEN tag = 'AssetsNoncurrent' AND ddate = period_yyyymmdd THEN value END) as noncurrent_assets,\n    MAX(CASE WHEN tag = 'PropertyPlantAndEquipmentNet' AND ddate = period_yyyymmdd THEN value END) as ppe_net,\n    \n    MAX(CASE WHEN tag = 'Liabilities' AND ddate = period_yyyymmdd THEN value END) as liabilities,\n    MAX(CASE WHEN tag = 'LiabilitiesCurrent' AND ddate = period_yyyymmdd THEN value END) as current_liabilities,\n    MAX(CASE WHEN tag = 'AccountsPayableCurrent' AND ddate = period_yyyymmdd THEN value END) as accounts_payable,\n    MAX(CASE WHEN tag IN ('ShortTermBorrowings', 'DebtCurrent') AND ddate = period_yyyymmdd THEN value END) as short_term_debt,\n    -- MODIFICACI\u00d3N 2025-12-12: Combinar Noncurrent + Current para mejor coverage\n    COALESCE(\n      MAX(CASE WHEN tag = 'LongTermDebtNoncurrent' AND ddate = period_yyyymmdd THEN value END),\n      0\n    ) + COALESCE(\n      MAX(CASE WHEN tag = 'LongTermDebtCurrent' AND ddate = period_yyyymmdd THEN value END),\n      0\n    ) as long_term_debt,\n    -- Campos separados para transparencia\n    MAX(CASE WHEN tag = 'LongTermDebtNoncurrent' AND ddate = period_yyyymmdd THEN value END) as long_term_debt_noncurrent,\n    MAX(CASE WHEN tag = 'LongTermDebtCurrent' AND ddate = period_yyyymmdd THEN value END) as long_term_debt_current,\n    MAX(CASE WHEN tag = 'LiabilitiesNoncurrent' AND ddate = period_yyyymmdd THEN value END) as noncurrent_liabilities,\n    \n    -- CORRECCI\u00d3N: Calcular StockholdersEquity como LiabilitiesAndStockholdersEquity - Liabilities si est\u00e1 disponible\n    -- Esto asegura que Assets = Liabilities + StockholdersEquity\n    COALESCE(\n      MAX(CASE WHEN tag = 'LiabilitiesAndStockholdersEquity' AND ddate = period_yyyymmdd THEN value END) \n        - MAX(CASE WHEN tag = 'Liabilities' AND ddate = period_yyyymmdd THEN value END),\n      MAX(CASE WHEN tag IN ('StockholdersEquity', 'StockholdersEquityIncludingPortionAttributableToNoncontrollingInterest') AND ddate = period_yyyymmdd THEN value END)\n    ) as stockholders_equity,\n    MAX(CASE WHEN tag = 'RetainedEarningsAccumulatedDeficit' AND ddate = period_yyyymmdd THEN value END) as retained_earnings\n    \n  FROM base_data\n  WHERE qtrs = 0  -- Balance sheet = instant (point in time)\n  GROUP BY ticker, cik, fiscal_year, fiscal_period, period_end_date  -- CORRECCI\u00d3N: Remover adsh del GROUP BY para evitar duplicados\n  ;\n  \n  SELECT COUNT(*) as balance_sheet_pivot_rows FROM balance_sheet_pivot;\n  \n  -- =========================================================================\n  -- CTE 4: PIVOT CASH FLOW TAGS\n  -- =========================================================================\n  \n  CREATE TEMP TABLE cash_flow_pivot AS\n  SELECT\n    ticker,\n    cik,\n    fiscal_year,\n    fiscal_period,\n    period_end_date,\n    adsh,\n    \n    -- Cash Flow fields\n    MAX(CASE WHEN tag = 'NetCashProvidedByUsedInOperatingActivities' THEN value END) as operating_cash_flow,\n    MAX(CASE WHEN tag = 'NetCashProvidedByUsedInInvestingActivities' THEN value END) as investing_cash_flow,\n    MAX(CASE WHEN tag = 'NetCashProvidedByUsedInFinancingActivities' THEN value END) as financing_cash_flow,\n    MAX(CASE WHEN tag = 'PaymentsToAcquirePropertyPlantAndEquipment' THEN value END) as capex,\n    MAX(CASE WHEN tag IN ('PaymentsOfDividends', 'PaymentsOfDividendsCommonStock') THEN value END) as dividends_paid\n    \n  FROM base_data\n  WHERE qtrs IN (1, 4)  -- Cash flow = period (1=Q, 4=annual)\n  GROUP BY ticker, cik, fiscal_year, fiscal_period, period_end_date, adsh\n  ;\n  \n  SELECT COUNT(*) as cash_flow_pivot_rows FROM cash_flow_pivot;\n  \n  -- =========================================================================\n  -- CTE 4.5: SHARES FROM NUM (NUEVO)\n  -- =========================================================================\n  \n  CREATE TEMP TABLE shares_from_num AS\n  SELECT\n    n.adsh,\n    \n    -- Shares consolidado con prioridad\n    CAST(COALESCE(\n      MAX(CASE WHEN n.tag = 'WeightedAverageNumberOfDilutedSharesOutstanding' THEN n.value END),\n      MAX(CASE WHEN n.tag = 'WeightedAverageNumberOfSharesOutstandingBasic' THEN n.value END),\n      MAX(CASE WHEN n.tag = 'CommonStockSharesOutstanding' THEN n.value END),\n      MAX(CASE WHEN n.tag = 'SharesOutstanding' THEN n.value END)\n    ) AS INT64) as shares_outstanding_consolidated,\n    \n    -- Identificar source\n    CASE\n      WHEN MAX(CASE WHEN n.tag = 'WeightedAverageNumberOfDilutedSharesOutstanding' THEN 1 END) = 1 THEN 'diluted'\n      WHEN MAX(CASE WHEN n.tag = 'WeightedAverageNumberOfSharesOutstandingBasic' THEN 1 END) = 1 THEN 'basic'\n      WHEN MAX(CASE WHEN n.tag = 'CommonStockSharesOutstanding' THEN 1 END) = 1 THEN 'common'\n      WHEN MAX(CASE WHEN n.tag = 'SharesOutstanding' THEN n.value END) IS NOT NULL THEN 'generic'\n    END as shares_source_num\n    \n  FROM `sunny-advantage-471523-b3.IS_Fundamentales.Num` n\n  WHERE n.tag IN (\n    'WeightedAverageNumberOfDilutedSharesOutstanding',\n    'WeightedAverageNumberOfSharesOutstandingBasic',\n    'CommonStockSharesOutstanding',\n    'SharesOutstanding'\n  )\n    AND n.value > 0\n  GROUP BY n.adsh\n  ;\n  \n  SELECT COUNT(*) as shares_from_num_rows FROM shares_from_num;\n  \n  -- =========================================================================\n  -- CTE 5: COMBINE ALL + CALCULATE Q4\n  -- =========================================================================\n  \n  CREATE TEMP TABLE combined_statements AS\n  SELECT\n    -- Identity\n    isp.ticker,\n    isp.cik,\n    isp.company_name,\n    isp.fiscal_year,\n    isp.fiscal_period,\n    isp.period_end_date,\n    CASE \n      WHEN isp.fiscal_year_end_mmdd IS NOT NULL \n      THEN CAST(isp.fiscal_year_end_mmdd AS STRING)\n      ELSE NULL\n    END as fiscal_year_end,\n    isp.period_type,\n    isp.form_type,\n    isp.filing_date,\n    \n    -- Flag calculated\n    FALSE as is_calculated,\n    \n    -- Income Statement\n    isp.revenues,\n    isp.cost_of_revenue,\n    isp.gross_profit,\n    isp.operating_expenses,\n    isp.research_development,\n    isp.selling_general_admin,\n    isp.operating_income,\n    isp.interest_expense,\n    isp.interest_income,\n    isp.other_income_expense,\n    isp.income_before_tax,\n    isp.income_tax_expense,\n    isp.net_income,\n    isp.eps_basic,\n    isp.eps_diluted,\n    isp.shares_outstanding_basic,\n    isp.shares_outstanding_diluted,\n    -- Shares outstanding (prioridad: Num extra\u00eddo > nativo)\n    COALESCE(sfn.shares_outstanding_consolidated, isp.shares_outstanding_diluted, isp.shares_outstanding_basic) \n      as shares_outstanding_consolidated,\n    COALESCE(\n      CASE WHEN sfn.shares_outstanding_consolidated IS NOT NULL THEN sfn.shares_source_num END,\n      CASE WHEN isp.shares_outstanding_diluted IS NOT NULL THEN 'native_diluted' END,\n      CASE WHEN isp.shares_outstanding_basic IS NOT NULL THEN 'native_basic' END\n    ) as shares_source,\n    \n    -- Balance Sheet\n    bsp.assets,\n    bsp.current_assets,\n    bsp.cash_and_equivalents,\n    bsp.short_term_investments,\n    bsp.accounts_receivable,\n    bsp.inventory,\n    bsp.noncurrent_assets,\n    bsp.ppe_net,\n    bsp.liabilities,\n    bsp.current_liabilities,\n    bsp.accounts_payable,\n    bsp.short_term_debt,\n    bsp.long_term_debt,\n    bsp.long_term_debt_noncurrent,\n    bsp.long_term_debt_current,\n    bsp.noncurrent_liabilities,\n    bsp.stockholders_equity,\n    bsp.retained_earnings,\n    \n    -- Cash Flow\n    cfp.operating_cash_flow,\n    cfp.investing_cash_flow,\n    cfp.financing_cash_flow,\n    cfp.capex,\n    -- Calculate FCF\n    COALESCE(cfp.operating_cash_flow, 0) + COALESCE(cfp.capex, 0) as free_cash_flow,\n    cfp.dividends_paid,\n    \n    -- Data quality (% of non-null key fields)\n    (\n      (CASE WHEN isp.revenues IS NOT NULL THEN 1 ELSE 0 END) +\n      (CASE WHEN isp.net_income IS NOT NULL THEN 1 ELSE 0 END) +\n      (CASE WHEN bsp.assets IS NOT NULL THEN 1 ELSE 0 END) +\n      (CASE WHEN bsp.stockholders_equity IS NOT NULL THEN 1 ELSE 0 END) +\n      (CASE WHEN cfp.operating_cash_flow IS NOT NULL THEN 1 ELSE 0 END)\n    ) / 5.0 as data_quality_score\n    \n  FROM income_statement_pivot isp\n  LEFT JOIN balance_sheet_pivot bsp \n    ON isp.ticker = bsp.ticker \n    AND isp.fiscal_year = bsp.fiscal_year \n    AND isp.fiscal_period = bsp.fiscal_period\n  LEFT JOIN cash_flow_pivot cfp\n    ON isp.ticker = cfp.ticker \n    AND isp.fiscal_year = cfp.fiscal_year \n    AND isp.fiscal_period = cfp.fiscal_period\n  LEFT JOIN shares_from_num sfn\n    ON isp.adsh = sfn.adsh\n  \n  UNION ALL\n  \n  -- Q4_CALC: Usar CTE simplificado para evitar problemas de GROUP BY\n  SELECT\n    q4.ticker,\n    q4.cik,\n    q4.company_name,\n    q4.fiscal_year,\n    q4.fiscal_period,\n    q4.period_end_date,\n    q4.fiscal_year_end,\n    q4.period_type,\n    q4.form_type,\n    q4.filing_date,\n    q4.is_calculated,\n    q4.revenues,\n    q4.cost_of_revenue,\n    q4.gross_profit,\n    q4.operating_expenses,\n    q4.research_development,\n    q4.selling_general_admin,\n    q4.operating_income,\n    q4.interest_expense,\n    q4.interest_income,\n    q4.other_income_expense,\n    q4.income_before_tax,\n    q4.income_tax_expense,\n    q4.net_income,\n    q4.eps_basic,\n    q4.eps_diluted,\n    q4.shares_outstanding_basic,\n    q4.shares_outstanding_diluted,\n    q4.shares_outstanding_consolidated,\n    q4.shares_source,\n    q4.assets,\n    q4.current_assets,\n    q4.cash_and_equivalents,\n    q4.short_term_investments,\n    q4.accounts_receivable,\n    q4.inventory,\n    q4.noncurrent_assets,\n    q4.ppe_net,\n    q4.liabilities,\n    q4.current_liabilities,\n    q4.accounts_payable,\n    q4.short_term_debt,\n    q4.long_term_debt,\n    q4.long_term_debt_noncurrent,\n    q4.long_term_debt_current,\n    q4.noncurrent_liabilities,\n    q4.stockholders_equity,\n    q4.retained_earnings,\n    q4.operating_cash_flow,\n    q4.investing_cash_flow,\n    q4.financing_cash_flow,\n    q4.capex,\n    q4.free_cash_flow,\n    q4.dividends_paid,\n    q4.data_quality_score\n  FROM (\n    -- CTE simplificado para c\u00e1lculo Q4\n    WITH annual_data AS (\n      SELECT \n        isp.ticker, isp.cik, isp.company_name, isp.fiscal_year,\n        isp.period_end_date, isp.fiscal_year_end_mmdd, isp.form_type, isp.filing_date,\n        isp.revenues, isp.cost_of_revenue, isp.gross_profit, isp.operating_expenses,\n        isp.research_development, isp.selling_general_admin, isp.operating_income,\n        isp.interest_expense, isp.interest_income, isp.other_income_expense,\n        isp.income_before_tax, isp.income_tax_expense, isp.net_income,\n        isp.eps_basic, isp.eps_diluted, isp.shares_outstanding_basic, isp.shares_outstanding_diluted,\n        COALESCE(sfn.shares_outstanding_consolidated, isp.shares_outstanding_diluted, isp.shares_outstanding_basic) as shares_outstanding_consolidated,\n        COALESCE(\n          CASE WHEN sfn.shares_outstanding_consolidated IS NOT NULL THEN sfn.shares_source_num END,\n          CASE WHEN isp.shares_outstanding_diluted IS NOT NULL THEN 'native_diluted' END,\n          CASE WHEN isp.shares_outstanding_basic IS NOT NULL THEN 'native_basic' END\n        ) as shares_source,\n        bsp.assets, bsp.current_assets, bsp.cash_and_equivalents, bsp.short_term_investments,\n        bsp.accounts_receivable, bsp.inventory, bsp.noncurrent_assets, bsp.ppe_net,\n        bsp.liabilities, bsp.current_liabilities, bsp.accounts_payable, bsp.short_term_debt,\n        bsp.long_term_debt,\n    bsp.long_term_debt_noncurrent,\n    bsp.long_term_debt_current, bsp.noncurrent_liabilities, bsp.stockholders_equity, bsp.retained_earnings,\n        cfp.operating_cash_flow, cfp.investing_cash_flow, cfp.financing_cash_flow,\n        cfp.capex, COALESCE(cfp.operating_cash_flow, 0) + COALESCE(cfp.capex, 0) as free_cash_flow,\n        cfp.dividends_paid\n      FROM income_statement_pivot isp\n      LEFT JOIN balance_sheet_pivot bsp\n        ON isp.ticker = bsp.ticker\n        AND isp.fiscal_year = bsp.fiscal_year\n        AND isp.fiscal_period = bsp.fiscal_period\n      LEFT JOIN cash_flow_pivot cfp\n        ON isp.ticker = cfp.ticker\n        AND isp.fiscal_year = cfp.fiscal_year\n        AND isp.fiscal_period = cfp.fiscal_period\n      LEFT JOIN shares_from_num sfn\n        ON isp.adsh = sfn.adsh\n      WHERE isp.fiscal_period = 'FY'\n    ),\n    quarterly_sum AS (\n      SELECT \n        isp.ticker, isp.fiscal_year,\n        SUM(isp.revenues) as sum_revenues,\n        SUM(isp.cost_of_revenue) as sum_cost_of_revenue,\n        SUM(isp.gross_profit) as sum_gross_profit,\n        SUM(isp.operating_expenses) as sum_operating_expenses,\n        SUM(isp.research_development) as sum_research_development,\n        SUM(isp.selling_general_admin) as sum_selling_general_admin,\n        SUM(isp.operating_income) as sum_operating_income,\n        SUM(isp.interest_expense) as sum_interest_expense,\n        SUM(isp.interest_income) as sum_interest_income,\n        SUM(isp.other_income_expense) as sum_other_income_expense,\n        SUM(isp.income_before_tax) as sum_income_before_tax,\n        SUM(isp.income_tax_expense) as sum_income_tax_expense,\n        SUM(isp.net_income) as sum_net_income,\n        -- \u2705 CORRECCI\u00d3N: Agregar sumas de EPS para c\u00e1lculo Q4\n        SUM(isp.eps_basic) as sum_eps_basic,\n        SUM(isp.eps_diluted) as sum_eps_diluted,\n        SUM(cfp.operating_cash_flow) as sum_operating_cash_flow,\n        SUM(cfp.investing_cash_flow) as sum_investing_cash_flow,\n        SUM(cfp.financing_cash_flow) as sum_financing_cash_flow,\n        SUM(cfp.capex) as sum_capex,\n        SUM(COALESCE(cfp.operating_cash_flow, 0) + COALESCE(cfp.capex, 0)) as sum_free_cash_flow,\n        SUM(cfp.dividends_paid) as sum_dividends_paid\n      FROM income_statement_pivot isp\n      LEFT JOIN cash_flow_pivot cfp\n        ON isp.ticker = cfp.ticker\n        AND isp.fiscal_year = cfp.fiscal_year\n        AND isp.fiscal_period = cfp.fiscal_period\n      WHERE isp.fiscal_period IN ('Q1', 'Q2', 'Q3')\n      GROUP BY isp.ticker, isp.fiscal_year\n    )\n    SELECT \n      a.ticker, a.cik, a.company_name, a.fiscal_year,\n      'Q4_calc' as fiscal_period,\n      a.period_end_date,\n      CASE \n        WHEN a.fiscal_year_end_mmdd IS NOT NULL \n        THEN CAST(a.fiscal_year_end_mmdd AS STRING)\n        ELSE NULL\n      END as fiscal_year_end,\n      'quarterly' as period_type,\n      a.form_type,\n      a.filing_date,\n      TRUE as is_calculated,\n      -- IS: Annual - sum(Q1,Q2,Q3)\n      CASE WHEN a.revenues IS NOT NULL THEN a.revenues - COALESCE(q.sum_revenues, 0) ELSE NULL END as revenues,\n      CASE WHEN a.cost_of_revenue IS NOT NULL THEN a.cost_of_revenue - COALESCE(q.sum_cost_of_revenue, 0) ELSE NULL END as cost_of_revenue,\n      CASE WHEN a.gross_profit IS NOT NULL THEN a.gross_profit - COALESCE(q.sum_gross_profit, 0) ELSE NULL END as gross_profit,\n      CASE WHEN a.operating_expenses IS NOT NULL THEN a.operating_expenses - COALESCE(q.sum_operating_expenses, 0) ELSE NULL END as operating_expenses,\n      CASE WHEN a.research_development IS NOT NULL THEN a.research_development - COALESCE(q.sum_research_development, 0) ELSE NULL END as research_development,\n      CASE WHEN a.selling_general_admin IS NOT NULL THEN a.selling_general_admin - COALESCE(q.sum_selling_general_admin, 0) ELSE NULL END as selling_general_admin,\n      CASE WHEN a.operating_income IS NOT NULL THEN a.operating_income - COALESCE(q.sum_operating_income, 0) ELSE NULL END as operating_income,\n      CASE WHEN a.interest_expense IS NOT NULL THEN a.interest_expense - COALESCE(q.sum_interest_expense, 0) ELSE NULL END as interest_expense,\n      CASE WHEN a.interest_income IS NOT NULL THEN a.interest_income - COALESCE(q.sum_interest_income, 0) ELSE NULL END as interest_income,\n      CASE WHEN a.other_income_expense IS NOT NULL THEN a.other_income_expense - COALESCE(q.sum_other_income_expense, 0) ELSE NULL END as other_income_expense,\n      CASE WHEN a.income_before_tax IS NOT NULL THEN a.income_before_tax - COALESCE(q.sum_income_before_tax, 0) ELSE NULL END as income_before_tax,\n      CASE WHEN a.income_tax_expense IS NOT NULL THEN a.income_tax_expense - COALESCE(q.sum_income_tax_expense, 0) ELSE NULL END as income_tax_expense,\n      CASE WHEN a.net_income IS NOT NULL THEN a.net_income - COALESCE(q.sum_net_income, 0) ELSE NULL END as net_income,\n      -- \u2705 CORRECCI\u00d3N: EPS calculado = FY - (Q1 + Q2 + Q3)\n      CASE WHEN a.eps_basic IS NOT NULL THEN a.eps_basic - COALESCE(q.sum_eps_basic, 0) ELSE NULL END as eps_basic,\n      CASE WHEN a.eps_diluted IS NOT NULL THEN a.eps_diluted - COALESCE(q.sum_eps_diluted, 0) ELSE NULL END as eps_diluted,\n      a.shares_outstanding_basic, a.shares_outstanding_diluted,\n      a.shares_outstanding_consolidated, a.shares_source,\n      -- BS: usar annual end-of-year snapshot\n      a.assets, a.current_assets, a.cash_and_equivalents, a.short_term_investments,\n      a.accounts_receivable, a.inventory, a.noncurrent_assets, a.ppe_net,\n      a.liabilities, a.current_liabilities, a.accounts_payable, a.short_term_debt,\n      a.long_term_debt, a.long_term_debt_noncurrent, a.long_term_debt_current, a.noncurrent_liabilities, a.stockholders_equity, a.retained_earnings,\n      -- CF: Annual - sum(Q1,Q2,Q3)\n      CASE WHEN a.operating_cash_flow IS NOT NULL THEN a.operating_cash_flow - COALESCE(q.sum_operating_cash_flow, 0) ELSE NULL END as operating_cash_flow,\n      CASE WHEN a.investing_cash_flow IS NOT NULL THEN a.investing_cash_flow - COALESCE(q.sum_investing_cash_flow, 0) ELSE NULL END as investing_cash_flow,\n      CASE WHEN a.financing_cash_flow IS NOT NULL THEN a.financing_cash_flow - COALESCE(q.sum_financing_cash_flow, 0) ELSE NULL END as financing_cash_flow,\n      CASE WHEN a.capex IS NOT NULL THEN a.capex - COALESCE(q.sum_capex, 0) ELSE NULL END as capex,\n      CASE WHEN a.free_cash_flow IS NOT NULL THEN a.free_cash_flow - COALESCE(q.sum_free_cash_flow, 0) ELSE NULL END as free_cash_flow,\n      CASE WHEN a.dividends_paid IS NOT NULL THEN a.dividends_paid - COALESCE(q.sum_dividends_paid, 0) ELSE NULL END as dividends_paid,\n      -- Data quality score\n      (\n        (CASE WHEN a.revenues IS NOT NULL THEN 1 ELSE 0 END) +\n        (CASE WHEN a.net_income IS NOT NULL THEN 1 ELSE 0 END) +\n        (CASE WHEN a.assets IS NOT NULL THEN 1 ELSE 0 END) +\n        (CASE WHEN a.stockholders_equity IS NOT NULL THEN 1 ELSE 0 END) +\n        (CASE WHEN a.operating_cash_flow IS NOT NULL THEN 1 ELSE 0 END)\n      ) / 5.0 * 0.8 as data_quality_score\n      FROM annual_data a\n      LEFT JOIN quarterly_sum q \n        ON a.ticker = q.ticker \n        AND a.fiscal_year = q.fiscal_year\n    WHERE a.revenues IS NOT NULL  -- Solo calcular si hay annual data\n  ) q4\n  ;\n  \n  SELECT COUNT(*) as combined_statements_rows FROM combined_statements;\n  \n  -- =========================================================================\n  -- STEP 6: INSERT TO fundamentals_timeseries (TRUNCATE + INSERT)\n  -- =========================================================================\n  \n  -- Truncate existing data (idempotente)\n  TRUNCATE TABLE `sunny-advantage-471523-b3.IS_Fundamentales.fundamentals_timeseries`;\n  \n  -- Insert all data with EXPLICIT column names to ensure correct mapping\n  INSERT INTO `sunny-advantage-471523-b3.IS_Fundamentales.fundamentals_timeseries` (\n    ticker,\n    cik,\n    company_name,\n    fiscal_year,\n    fiscal_period,\n    period_end_date,\n    fiscal_year_end,\n    is_calculated,\n    period_type,\n    form_type,\n    filing_date,\n    revenues,\n    cost_of_revenue,\n    gross_profit,\n    operating_expenses,\n    research_development,\n    selling_general_admin,\n    operating_income,\n    interest_expense,\n    interest_income,\n    other_income_expense,\n    income_before_tax,\n    income_tax_expense,\n    net_income,\n    eps_basic,\n    eps_diluted,\n    shares_outstanding_basic,\n    shares_outstanding_diluted,\n    shares_outstanding_consolidated,\n    shares_source,\n    assets,\n    current_assets,\n    cash_and_equivalents,\n    short_term_investments,\n    accounts_receivable,\n    inventory,\n    noncurrent_assets,\n    ppe_net,\n    liabilities,\n    current_liabilities,\n    accounts_payable,\n    short_term_debt,\n    long_term_debt,\n    long_term_debt_noncurrent,\n    long_term_debt_current,\n    noncurrent_liabilities,\n    stockholders_equity,\n    retained_earnings,\n    operating_cash_flow,\n    investing_cash_flow,\n    financing_cash_flow,\n    capex,\n    free_cash_flow,\n    dividends_paid,\n    data_quality_score,\n    last_updated\n  )\n  SELECT \n    CAST(ticker AS STRING),\n    CAST(cik AS INT64),\n    CAST(company_name AS STRING),\n    CAST(fiscal_year AS INT64),\n    CAST(fiscal_period AS STRING),\n    CAST(period_end_date AS DATE),\n    CAST(fiscal_year_end AS STRING),\n    CAST(is_calculated AS BOOL),\n    CAST(period_type AS STRING),\n    CAST(form_type AS STRING),\n    CAST(filing_date AS DATE),\n    -- Income Statement (FLOAT64)\n    CAST(revenues AS FLOAT64),\n    CAST(cost_of_revenue AS FLOAT64),\n    CAST(gross_profit AS FLOAT64),\n    CAST(operating_expenses AS FLOAT64),\n    CAST(research_development AS FLOAT64),\n    CAST(selling_general_admin AS FLOAT64),\n    CAST(operating_income AS FLOAT64),\n    CAST(interest_expense AS FLOAT64),\n    CAST(interest_income AS FLOAT64),\n    CAST(other_income_expense AS FLOAT64),\n    CAST(income_before_tax AS FLOAT64),\n    CAST(income_tax_expense AS FLOAT64),\n    CAST(net_income AS FLOAT64),\n    CAST(eps_basic AS FLOAT64),\n    CAST(eps_diluted AS FLOAT64),\n    -- Shares (FLOAT64 seg\u00fan schema para basic/diluted, INT64 para consolidated)\n    CAST(shares_outstanding_basic AS FLOAT64),\n    CAST(shares_outstanding_diluted AS FLOAT64),\n    CAST(shares_outstanding_consolidated AS INT64),\n    CAST(shares_source AS STRING),\n    -- Balance Sheet (FLOAT64)\n    CAST(assets AS FLOAT64),\n    CAST(current_assets AS FLOAT64),\n    CAST(cash_and_equivalents AS FLOAT64),\n    CAST(short_term_investments AS FLOAT64),\n    CAST(accounts_receivable AS FLOAT64),\n    CAST(inventory AS FLOAT64),\n    CAST(noncurrent_assets AS FLOAT64),\n    CAST(ppe_net AS FLOAT64),\n    CAST(liabilities AS FLOAT64),\n    CAST(current_liabilities AS FLOAT64),\n    CAST(accounts_payable AS FLOAT64),\n    CAST(short_term_debt AS FLOAT64),\n    CAST(long_term_debt AS FLOAT64),\n    CAST(long_term_debt_noncurrent AS FLOAT64),\n    CAST(long_term_debt_current AS FLOAT64),\n    CAST(noncurrent_liabilities AS FLOAT64),\n    CAST(stockholders_equity AS FLOAT64),\n    CAST(retained_earnings AS FLOAT64),\n    -- Cash Flow (FLOAT64)\n    CAST(operating_cash_flow AS FLOAT64),\n    CAST(investing_cash_flow AS FLOAT64),\n    CAST(financing_cash_flow AS FLOAT64),\n    CAST(capex AS FLOAT64),\n    CAST(free_cash_flow AS FLOAT64),\n    CAST(dividends_paid AS FLOAT64),\n    CAST(data_quality_score AS FLOAT64),\n    CAST(last_refresh_time AS TIMESTAMP)\n  FROM combined_statements\n  WHERE data_quality_score >= 0.4\n  ;\n  \n  SELECT CONCAT('\u2705 Inserted ', CAST(@@row_count AS STRING), ' rows to fundamentals_timeseries') as log_message;\n  \n  -- =========================================================================\n  -- STEP 7: CALCULATE RATIOS \u2192 fundamentals_ratios\n  -- =========================================================================\n  \n  -- \u2705 CORRECCI\u00d3N: Removida tabla latest_prices (ya no se usan ratios dependientes de precio)\n\n  TRUNCATE TABLE `sunny-advantage-471523-b3.IS_Fundamentales.fundamentals_ratios`;\n  \n  INSERT INTO `sunny-advantage-471523-b3.IS_Fundamentales.fundamentals_ratios`\n  SELECT\n    ft.ticker,\n    ft.cik,\n    ft.company_name,\n    ft.fiscal_year,\n    ft.fiscal_period,\n    ft.period_end_date,\n    ft.period_type,\n    \n    -- PROFITABILITY RATIOS\n    SAFE_DIVIDE(ft.gross_profit, ft.revenues) as gross_margin,\n    SAFE_DIVIDE(ft.operating_income, ft.revenues) as operating_margin,\n    SAFE_DIVIDE(ft.net_income, ft.revenues) as net_margin,\n    SAFE_DIVIDE(ft.net_income, ft.stockholders_equity) as roe,\n    SAFE_DIVIDE(ft.net_income, ft.assets) as roa,\n    SAFE_DIVIDE(ft.net_income, (ft.assets - ft.current_liabilities)) as roic,  -- Simplified ROIC\n    \n    -- LIQUIDITY RATIOS\n    SAFE_DIVIDE(ft.current_assets, ft.current_liabilities) as current_ratio,\n    SAFE_DIVIDE((ft.current_assets - ft.inventory), ft.current_liabilities) as quick_ratio,\n    SAFE_DIVIDE(ft.cash_and_equivalents, ft.current_liabilities) as cash_ratio,\n    ft.current_assets - ft.current_liabilities as working_capital,\n    \n    -- LEVERAGE RATIOS\n    -- FIX 2025-12-12: COALESCE para manejar NULL en debts\n    -- Problema: (NULL + value) = NULL en SQL\n    -- Soluci\u00f3n: COALESCE(NULL, 0) trata NULL como 0\n    -- Impacto: Coverage DE: 12.13% \u2192 86.75% (+4,738 tickers)\n    SAFE_DIVIDE((COALESCE(ft.short_term_debt, 0) + COALESCE(ft.long_term_debt, 0)), ft.stockholders_equity) as debt_to_equity,\n    SAFE_DIVIDE((ft.short_term_debt + ft.long_term_debt), ft.assets) as debt_to_assets,\n    SAFE_DIVIDE(ft.stockholders_equity, ft.assets) as equity_ratio,\n    SAFE_DIVIDE(ft.operating_income, ft.interest_expense) as interest_coverage,\n    \n    -- EFFICIENCY RATIOS\n    SAFE_DIVIDE(ft.revenues, ft.assets) as asset_turnover,\n    SAFE_DIVIDE(ft.cost_of_revenue, ft.inventory) as inventory_turnover,\n    SAFE_DIVIDE(ft.revenues, ft.accounts_receivable) as receivables_turnover,\n    SAFE_DIVIDE(365, SAFE_DIVIDE(ft.revenues, ft.accounts_receivable)) as days_sales_outstanding,\n    \n    -- CASH FLOW RATIOS\n    SAFE_DIVIDE(ft.free_cash_flow, ft.revenues) as fcf_margin,\n    SAFE_DIVIDE(ft.operating_cash_flow, ft.current_liabilities) as operating_cf_ratio,\n    SAFE_DIVIDE(ft.operating_cash_flow, (ft.short_term_debt + ft.long_term_debt)) as cash_flow_to_debt,\n    SAFE_DIVIDE(ABS(ft.capex), ft.revenues) as capex_to_revenue,\n\n    -- \u2705 CORRECCI\u00d3N: REMOVIDOS ratios dependientes de precio (price_to_earnings, price_to_book, price_to_sales, peg_ratio)\n    -- Estos deben calcularse en tiempo real usando el precio actual del mercado\n\n    -- GROWTH METRICS YoY (calculate from lagged data)\n    SAFE_DIVIDE(\n      (ft.revenues - LAG(ft.revenues, 1) OVER (PARTITION BY ft.ticker, ft.fiscal_period ORDER BY ft.fiscal_year)),\n      LAG(ft.revenues, 1) OVER (PARTITION BY ft.ticker, ft.fiscal_period ORDER BY ft.fiscal_year)\n    ) * 100 as revenue_growth_yoy,\n    \n    SAFE_DIVIDE(\n      (ft.net_income - LAG(ft.net_income, 1) OVER (PARTITION BY ft.ticker, ft.fiscal_period ORDER BY ft.fiscal_year)),\n      LAG(ft.net_income, 1) OVER (PARTITION BY ft.ticker, ft.fiscal_period ORDER BY ft.fiscal_year)\n    ) * 100 as net_income_growth_yoy,\n    \n    SAFE_DIVIDE(\n      (ft.eps_diluted - LAG(ft.eps_diluted, 1) OVER (PARTITION BY ft.ticker, ft.fiscal_period ORDER BY ft.fiscal_year)),\n      LAG(ft.eps_diluted, 1) OVER (PARTITION BY ft.ticker, ft.fiscal_period ORDER BY ft.fiscal_year)\n    ) * 100 as eps_growth_yoy,\n    \n    SAFE_DIVIDE(\n      (ft.free_cash_flow - LAG(ft.free_cash_flow, 1) OVER (PARTITION BY ft.ticker, ft.fiscal_period ORDER BY ft.fiscal_year)),\n      LAG(ft.free_cash_flow, 1) OVER (PARTITION BY ft.ticker, ft.fiscal_period ORDER BY ft.fiscal_year)\n    ) * 100 as fcf_growth_yoy,\n    \n    -- Data quality\n    ft.data_quality_score,\n    ft.last_updated\n    \n  FROM `sunny-advantage-471523-b3.IS_Fundamentales.fundamentals_timeseries` ft\n  -- \u2705 CORRECCI\u00d3N: Removido LEFT JOIN con latest_prices\n  WHERE ft.fiscal_period IN ('Q1', 'Q2', 'Q3', 'Q4_calc', 'FY')  -- All periods\n  ;\n  \n  SELECT CONCAT('\u2705 Inserted ', CAST(@@row_count AS STRING), ' rows to fundamentals_ratios') as log_message;\n  \n  -- =========================================================================\n  -- FINAL LOG\n  -- =========================================================================\n  SELECT CONCAT('\u2705 Refresh completado: ', CAST(CURRENT_TIMESTAMP() AS STRING)) as log_message;\n  \nEND"
}