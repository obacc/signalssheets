{
  "etag": "qNBrBZ9toWXu2rNa8ZohSg==",
  "routineReference": {
    "projectId": "sunny-advantage-471523-b3",
    "datasetId": "IS_Fundamentales",
    "routineId": "sp_generate_trinity_signals"
  },
  "routineType": "PROCEDURE",
  "creationTime": "1765336267047",
  "lastModifiedTime": "1765336267047",
  "language": "SQL",
  "arguments": [
    {
      "name": "execution_date",
      "dataType": {
        "typeKind": "DATE"
      }
    }
  ],
  "definitionBody": "BEGIN\r\n  -- ========================================================================\r\n  -- PASO 1: DECLARE VARIABLES\r\n  -- ========================================================================\r\n  DECLARE v_scenario STRING DEFAULT 'Moderate';\r\n  DECLARE v_execution_ts TIMESTAMP;\r\n  DECLARE v_rows_processed INT64 DEFAULT 0;\r\n  DECLARE v_rows_inserted INT64 DEFAULT 0;\r\n\r\n  -- Lynch Parameters\r\n  DECLARE p_lynch_weight FLOAT64;\r\n  DECLARE p_lynch_peg_max FLOAT64;\r\n  DECLARE p_lynch_eps_growth_min FLOAT64;\r\n  DECLARE p_lynch_roe_min FLOAT64;\r\n\r\n  -- O'Neil Parameters\r\n  DECLARE p_oneil_weight FLOAT64;\r\n  DECLARE p_oneil_rs_min FLOAT64;\r\n  DECLARE p_oneil_eps_accel_min FLOAT64;\r\n  DECLARE p_oneil_volume_surge FLOAT64;\r\n\r\n  -- Graham Parameters\r\n  DECLARE p_graham_weight FLOAT64;\r\n  DECLARE p_graham_pe_max FLOAT64;\r\n  DECLARE p_graham_pb_max FLOAT64;\r\n  DECLARE p_graham_current_ratio_min FLOAT64;\r\n  DECLARE p_graham_debt_equity_max FLOAT64;\r\n\r\n  -- Universe Filters\r\n  DECLARE p_min_market_cap FLOAT64;\r\n  DECLARE p_min_volume FLOAT64;\r\n  DECLARE p_min_price FLOAT64;\r\n  DECLARE p_min_data_quality FLOAT64;\r\n\r\n  -- Signal Thresholds\r\n  DECLARE p_strong_buy_threshold FLOAT64;\r\n  DECLARE p_buy_threshold FLOAT64;\r\n  DECLARE p_hold_threshold FLOAT64;\r\n\r\n  -- Risk Management\r\n  DECLARE p_stop_loss_pct FLOAT64;\r\n  DECLARE p_target_pct FLOAT64;\r\n\r\n  -- Market Regime Variables\r\n  DECLARE v_current_regime STRING DEFAULT 'NEUTRAL';\r\n  DECLARE v_threshold_adjustment FLOAT64 DEFAULT 0;\r\n\r\n  SET v_execution_ts = CURRENT_TIMESTAMP();\r\n\r\n  -- Default execution_date to today if NULL\r\n  IF execution_date IS NULL THEN\r\n    SET execution_date = CURRENT_DATE();\r\n  END IF;\r\n\r\n  -- ========================================================================\r\n  -- PASO 2: LOAD PARAMETERS FROM parametros_trinity\r\n  -- ========================================================================\r\n\r\n  -- Lynch weights\r\n  SET p_lynch_weight = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'lynch_weight' AND is_active = TRUE\r\n  );\r\n  SET p_lynch_peg_max = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'lynch_peg_max' AND is_active = TRUE\r\n  );\r\n  SET p_lynch_eps_growth_min = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'lynch_eps_growth_min' AND is_active = TRUE\r\n  );\r\n  SET p_lynch_roe_min = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'lynch_roe_min' AND is_active = TRUE\r\n  );\r\n\r\n  -- O'Neil weights\r\n  SET p_oneil_weight = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'oneil_weight' AND is_active = TRUE\r\n  );\r\n  SET p_oneil_rs_min = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'oneil_rs_min' AND is_active = TRUE\r\n  );\r\n  SET p_oneil_eps_accel_min = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'oneil_eps_accel_min' AND is_active = TRUE\r\n  );\r\n  SET p_oneil_volume_surge = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'oneil_volume_surge' AND is_active = TRUE\r\n  );\r\n\r\n  -- Graham weights\r\n  SET p_graham_weight = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'graham_weight' AND is_active = TRUE\r\n  );\r\n  SET p_graham_pe_max = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'graham_pe_max' AND is_active = TRUE\r\n  );\r\n  SET p_graham_pb_max = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'graham_pb_max' AND is_active = TRUE\r\n  );\r\n  SET p_graham_current_ratio_min = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'graham_current_ratio_min' AND is_active = TRUE\r\n  );\r\n  SET p_graham_debt_equity_max = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'graham_debt_equity_max' AND is_active = TRUE\r\n  );\r\n\r\n  -- Universe filters\r\n  SET p_min_market_cap = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'min_market_cap' AND is_active = TRUE\r\n  );\r\n  SET p_min_volume = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'min_avg_volume' AND is_active = TRUE\r\n  );\r\n  SET p_min_price = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'min_price' AND is_active = TRUE\r\n  );\r\n  SET p_min_data_quality = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'min_data_quality_score' AND is_active = TRUE\r\n  );\r\n\r\n  -- Signal thresholds\r\n  SET p_strong_buy_threshold = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'strong_buy_threshold' AND is_active = TRUE\r\n  );\r\n  SET p_buy_threshold = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'buy_threshold' AND is_active = TRUE\r\n  );\r\n  SET p_hold_threshold = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'hold_threshold' AND is_active = TRUE\r\n  );\r\n\r\n  -- Risk management\r\n  SET p_stop_loss_pct = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'stop_loss_pct' AND is_active = TRUE\r\n  );\r\n  SET p_target_pct = (\r\n    SELECT CAST(parameter_value AS FLOAT64)\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.parametros_trinity`\r\n    WHERE scenario_name = v_scenario AND parameter_name = 'target_pct' AND is_active = TRUE\r\n  );\r\n\r\n  -- Set defaults if parameters not found\r\n  SET p_lynch_weight = COALESCE(p_lynch_weight, 0.35);\r\n  SET p_oneil_weight = COALESCE(p_oneil_weight, 0.35);\r\n  SET p_graham_weight = COALESCE(p_graham_weight, 0.30);\r\n  SET p_lynch_peg_max = COALESCE(p_lynch_peg_max, 2.0);\r\n  SET p_lynch_eps_growth_min = COALESCE(p_lynch_eps_growth_min, 15.0);\r\n  SET p_lynch_roe_min = COALESCE(p_lynch_roe_min, 15.0);\r\n  SET p_oneil_rs_min = COALESCE(p_oneil_rs_min, 70.0);\r\n  SET p_oneil_eps_accel_min = COALESCE(p_oneil_eps_accel_min, 20.0);\r\n  SET p_oneil_volume_surge = COALESCE(p_oneil_volume_surge, 1.5);\r\n  SET p_graham_pe_max = COALESCE(p_graham_pe_max, 15.0);\r\n  SET p_graham_pb_max = COALESCE(p_graham_pb_max, 1.5);\r\n  SET p_graham_current_ratio_min = COALESCE(p_graham_current_ratio_min, 2.0);\r\n  SET p_graham_debt_equity_max = COALESCE(p_graham_debt_equity_max, 0.5);\r\n  SET p_min_market_cap = COALESCE(p_min_market_cap, 500000000.0);\r\n  SET p_min_volume = COALESCE(p_min_volume, 100000.0);\r\n  SET p_min_price = COALESCE(p_min_price, 5.0);\r\n  SET p_min_data_quality = COALESCE(p_min_data_quality, 0.6);\r\n  SET p_strong_buy_threshold = COALESCE(p_strong_buy_threshold, 85.0);\r\n  SET p_buy_threshold = COALESCE(p_buy_threshold, 70.0);\r\n  SET p_hold_threshold = COALESCE(p_hold_threshold, 50.0);\r\n  SET p_stop_loss_pct = COALESCE(p_stop_loss_pct, 7.0);\r\n  SET p_target_pct = COALESCE(p_target_pct, 20.0);\r\n\r\n  -- ========================================================================\r\n  -- PASO 2.5: READ MARKET REGIME AND ADJUST THRESHOLDS\r\n  -- ========================================================================\r\n\r\n  -- Get current market regime\r\n  SET v_current_regime = (\r\n    SELECT regime_type\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.market_regime_daily`\r\n    WHERE regime_date <= execution_date\r\n    ORDER BY regime_date DESC\r\n    LIMIT 1\r\n  );\r\n\r\n  -- Default to NEUTRAL if no regime found\r\n  SET v_current_regime = COALESCE(v_current_regime, 'NEUTRAL');\r\n\r\n  -- Calculate threshold adjustment based on regime\r\n  -- BULL: Lower thresholds (easier to trigger BUY) -> -5\r\n  -- NEUTRAL: No adjustment -> 0\r\n  -- CORRECTION: Higher thresholds (harder to trigger BUY) -> +5\r\n  -- BEAR: Much higher thresholds -> +10\r\n  SET v_threshold_adjustment = CASE v_current_regime\r\n    WHEN 'BULL' THEN -5.0\r\n    WHEN 'NEUTRAL' THEN 0.0\r\n    WHEN 'CORRECTION' THEN 5.0\r\n    WHEN 'BEAR' THEN 10.0\r\n    ELSE 0.0\r\n  END;\r\n\r\n  -- Apply adjustment to thresholds\r\n  SET p_strong_buy_threshold = p_strong_buy_threshold + v_threshold_adjustment;\r\n  SET p_buy_threshold = p_buy_threshold + v_threshold_adjustment;\r\n  SET p_hold_threshold = p_hold_threshold + v_threshold_adjustment;\r\n\r\n  -- ========================================================================\r\n  -- PASO 3-12: CREATE TEMP TABLE WITH ALL CALCULATIONS AND INSERT\r\n  -- ========================================================================\r\n\r\n  -- Delete existing data for this date (idempotent)\r\n  DELETE FROM `sunny-advantage-471523-b3.IS_Fundamentales.trinity_signals_daily`\r\n  WHERE signal_date = execution_date;\r\n\r\n  -- Main calculation and insert\r\n  INSERT INTO `sunny-advantage-471523-b3.IS_Fundamentales.trinity_signals_daily` (\r\n    ticker, ticker_norm, company_name, sector, industry, signal_date,\r\n    price_current, price_52w_high, price_52w_low, volume_daily, volume_avg_50d, market_cap,\r\n    eps_ttm, revenues_ttm, net_income_ttm, stockholders_equity,\r\n    current_assets, current_liabilities, long_term_debt,\r\n    roe, current_ratio, revenue_growth_yoy, eps_growth_yoy, net_income_growth_yoy,\r\n    pe_ratio, pb_ratio, ps_ratio, peg_ratio, debt_to_equity,\r\n    lynch_score, lynch_peg_score, lynch_roe_score, lynch_eps_growth_score, lynch_revenue_growth_score,\r\n    oneil_score, oneil_rs_score, oneil_volume_score, oneil_momentum_score, oneil_eps_accel_score,\r\n    graham_score, graham_pb_score, graham_current_ratio_score, graham_debt_score, graham_stability_score,\r\n    trinity_score,\r\n    signal_strength, recommendation, confidence_level, entry_price, stop_loss, target_price, risk_reward_ratio,\r\n    ranking_position, percentile_rank, data_quality_score, has_complete_data, calculation_timestamp,\r\n    market_regime\r\n  )\r\n  WITH\r\n  -- PASO 3: Latest prices per ticker\r\n  latest_prices AS (\r\n    SELECT\r\n      REPLACE(p.ticker, '.US', '') AS ticker,  -- FIX: Normalize ticker format\r\n      p.close AS price_current,\r\n      p.vol AS volume_daily,\r\n      p.fecha AS price_date\r\n    FROM `sunny-advantage-471523-b3.market_data.Prices` p\r\n    INNER JOIN (\r\n      SELECT REPLACE(ticker, '.US', '') AS ticker, MAX(fecha) AS max_fecha  -- FIX: Normalize in subquery\r\n      FROM `sunny-advantage-471523-b3.market_data.Prices`\r\n      WHERE fecha <= execution_date\r\n      GROUP BY ticker\r\n    ) mp ON REPLACE(p.ticker, '.US', '') = mp.ticker AND p.fecha = mp.max_fecha\r\n  ),\r\n\r\n  -- PASO 4: 52-week high/low and volume average\r\n  price_stats AS (\r\n    SELECT\r\n      REPLACE(ticker, '.US', '') AS ticker,  -- FIX: Normalize ticker format\r\n      MAX(high) AS price_52w_high,\r\n      MIN(low) AS price_52w_low,\r\n      AVG(vol) AS volume_avg_50d\r\n    FROM `sunny-advantage-471523-b3.market_data.Prices`\r\n    WHERE fecha > DATE_SUB(execution_date, INTERVAL 365 DAY)\r\n      AND fecha <= execution_date\r\n    GROUP BY ticker\r\n  ),\r\n\r\n  -- PASO 5: Latest TTM fundamentals (fiscal year data as proxy for TTM)\r\n  latest_fundamentals AS (\r\n    SELECT\r\n      ft.ticker,\r\n      ft.company_name,\r\n      ft.eps_diluted AS eps_ttm,\r\n      ft.revenues AS revenues_ttm,\r\n      ft.net_income AS net_income_ttm,\r\n      ft.stockholders_equity,\r\n      ft.current_assets,\r\n      ft.current_liabilities,\r\n      ft.long_term_debt,\r\n      ft.data_quality_score,\r\n      ft.fiscal_year,\r\n      ft.period_end_date\r\n    FROM `sunny-advantage-471523-b3.IS_Fundamentales.fundamentals_timeseries` ft\r\n    INNER JOIN (\r\n      SELECT ticker, MAX(period_end_date) AS max_period\r\n      FROM `sunny-advantage-471523-b3.IS_Fundamentales.fundamentals_timeseries`\r\n      WHERE fiscal_period = 'FY'\r\n        AND period_end_date <= execution_date\r\n      GROUP BY ticker\r\n    ) mf ON ft.ticker = mf.ticker AND ft.period_end_date = mf.max_period\r\n    WHERE ft.fiscal_period = 'FY'\r\n  ),\r\n\r\n  -- PASO 6: Latest ratios (use most recent period, not just FY)\r\n  latest_ratios AS (\r\n    SELECT\r\n      ticker,\r\n      roe,\r\n      current_ratio,\r\n      debt_to_equity,\r\n      revenue_growth_yoy,\r\n      eps_growth_yoy,\r\n      net_income_growth_yoy\r\n    FROM (\r\n      SELECT\r\n        fr.ticker,\r\n        fr.roe,\r\n        fr.current_ratio,\r\n        fr.debt_to_equity,\r\n        fr.revenue_growth_yoy,\r\n        fr.eps_growth_yoy,\r\n        fr.net_income_growth_yoy,\r\n        ROW_NUMBER() OVER (PARTITION BY fr.ticker ORDER BY fr.period_end_date DESC) AS rn\r\n      FROM `sunny-advantage-471523-b3.IS_Fundamentales.fundamentals_ratios` fr\r\n      WHERE fr.period_end_date <= execution_date\r\n    )\r\n    WHERE rn = 1\r\n  ),\r\n\r\n  -- PASO 7: Calculate market cap and dynamic ratios\r\n  base_universe AS (\r\n    SELECT\r\n      lf.ticker,\r\n      LOWER(lf.ticker) AS ticker_norm,\r\n      lf.company_name,\r\n      COALESCE(ctm.sector, 'Unknown') AS sector,\r\n      COALESCE(ctm.industry, 'Unknown') AS industry,\r\n      execution_date AS signal_date,\r\n      lp.price_current,\r\n      ps.price_52w_high,\r\n      ps.price_52w_low,\r\n      lp.volume_daily,\r\n      ps.volume_avg_50d,\r\n      -- Market cap calculation (price * shares, estimate from stockholders equity / book value per share)\r\n      CASE\r\n        WHEN lf.stockholders_equity > 0 AND lf.eps_ttm > 0\r\n        THEN lp.price_current * (lf.stockholders_equity / (lf.stockholders_equity / NULLIF(lf.net_income_ttm, 0) * lf.eps_ttm))\r\n        ELSE lp.price_current * 1000000000 -- Default estimate\r\n      END AS market_cap,\r\n      lf.eps_ttm,\r\n      lf.revenues_ttm,\r\n      lf.net_income_ttm,\r\n      lf.stockholders_equity,\r\n      lf.current_assets,\r\n      lf.current_liabilities,\r\n      lf.long_term_debt,\r\n      -- Ratios from fundamentals_ratios\r\n      lr.roe * 100 AS roe, -- Convert to percentage\r\n      lr.current_ratio,\r\n      lr.revenue_growth_yoy AS revenue_growth_yoy, -- Already stored as percentage\r\n      lr.eps_growth_yoy AS eps_growth_yoy, -- Already stored as percentage\r\n      lr.net_income_growth_yoy AS net_income_growth_yoy, -- Already stored as percentage\r\n      lr.debt_to_equity,\r\n      -- Dynamic ratios\r\n      CASE WHEN lf.eps_ttm > 0 THEN lp.price_current / lf.eps_ttm ELSE NULL END AS pe_ratio,\r\n      CASE WHEN lf.stockholders_equity > 0\r\n           THEN lp.price_current / (lf.stockholders_equity / NULLIF(lf.net_income_ttm / NULLIF(lf.eps_ttm, 0), 0))\r\n           ELSE NULL END AS pb_ratio,\r\n      CASE WHEN lf.revenues_ttm > 0\r\n           THEN (lp.price_current * COALESCE(lf.net_income_ttm / NULLIF(lf.eps_ttm, 0), 1000000000)) / lf.revenues_ttm\r\n           ELSE NULL END AS ps_ratio,\r\n      -- PEG = P/E / EPS Growth Rate (eps_growth_yoy already as %)\r\n      CASE\r\n        WHEN lf.eps_ttm > 0 AND lr.eps_growth_yoy > 0\r\n        THEN (lp.price_current / lf.eps_ttm) / lr.eps_growth_yoy\r\n        ELSE NULL\r\n      END AS peg_ratio,\r\n      lf.data_quality_score,\r\n      -- Price momentum (relative strength proxy)\r\n      CASE WHEN ps.price_52w_low > 0\r\n           THEN ((lp.price_current - ps.price_52w_low) / ps.price_52w_low) * 100\r\n           ELSE 0 END AS price_momentum,\r\n      -- Volume ratio\r\n      CASE WHEN ps.volume_avg_50d > 0\r\n           THEN lp.volume_daily / ps.volume_avg_50d\r\n           ELSE 1 END AS volume_ratio\r\n    FROM latest_fundamentals lf\r\n    LEFT JOIN `sunny-advantage-471523-b3.IS_Fundamentales.cik_ticker_mapping` ctm\r\n      ON lf.ticker = ctm.ticker\r\n    INNER JOIN latest_prices lp ON lf.ticker = lp.ticker\r\n    INNER JOIN price_stats ps ON lf.ticker = ps.ticker\r\n    LEFT JOIN latest_ratios lr ON lf.ticker = lr.ticker\r\n    WHERE lp.price_current >= p_min_price\r\n      AND COALESCE(lf.data_quality_score, 0.7) >= p_min_data_quality\r\n  ),\r\n\r\n  -- PASO 8-10: Calculate Lynch, O'Neil, Graham scores\r\n  scored_universe AS (\r\n    SELECT\r\n      bu.*,\r\n      -- ================================================================\r\n      -- LYNCH SCORE (Value + Growth)\r\n      -- ================================================================\r\n      -- PEG Score (lower is better, <1 = 100, <2 = 75, else scaled)\r\n      CASE\r\n        WHEN bu.peg_ratio IS NULL THEN 50\r\n        WHEN bu.peg_ratio <= 0 THEN 0\r\n        WHEN bu.peg_ratio <= 0.5 THEN 100\r\n        WHEN bu.peg_ratio <= 1.0 THEN 90\r\n        WHEN bu.peg_ratio <= 1.5 THEN 75\r\n        WHEN bu.peg_ratio <= p_lynch_peg_max THEN 60\r\n        ELSE GREATEST(0, 100 - (bu.peg_ratio * 20))\r\n      END AS lynch_peg_score,\r\n\r\n      -- ROE Score (higher is better)\r\n      CASE\r\n        WHEN bu.roe IS NULL THEN 50\r\n        WHEN bu.roe >= 30 THEN 100\r\n        WHEN bu.roe >= 25 THEN 90\r\n        WHEN bu.roe >= p_lynch_roe_min THEN 75\r\n        WHEN bu.roe >= 10 THEN 60\r\n        WHEN bu.roe >= 5 THEN 40\r\n        ELSE 20\r\n      END AS lynch_roe_score,\r\n\r\n      -- EPS Growth Score\r\n      CASE\r\n        WHEN bu.eps_growth_yoy IS NULL THEN 50\r\n        WHEN bu.eps_growth_yoy >= 50 THEN 100\r\n        WHEN bu.eps_growth_yoy >= 30 THEN 90\r\n        WHEN bu.eps_growth_yoy >= p_lynch_eps_growth_min THEN 75\r\n        WHEN bu.eps_growth_yoy >= 10 THEN 60\r\n        WHEN bu.eps_growth_yoy >= 0 THEN 40\r\n        ELSE 20\r\n      END AS lynch_eps_growth_score,\r\n\r\n      -- Revenue Growth Score\r\n      CASE\r\n        WHEN bu.revenue_growth_yoy IS NULL THEN 50\r\n        WHEN bu.revenue_growth_yoy >= 30 THEN 100\r\n        WHEN bu.revenue_growth_yoy >= 20 THEN 85\r\n        WHEN bu.revenue_growth_yoy >= 10 THEN 70\r\n        WHEN bu.revenue_growth_yoy >= 5 THEN 55\r\n        WHEN bu.revenue_growth_yoy >= 0 THEN 40\r\n        ELSE 25\r\n      END AS lynch_revenue_growth_score,\r\n\r\n      -- ================================================================\r\n      -- O'NEIL SCORE (Momentum + Technical)\r\n      -- ================================================================\r\n      -- Relative Strength Score (price momentum percentile)\r\n      CASE\r\n        WHEN bu.price_momentum >= 100 THEN 100\r\n        WHEN bu.price_momentum >= 75 THEN 90\r\n        WHEN bu.price_momentum >= p_oneil_rs_min THEN 80\r\n        WHEN bu.price_momentum >= 50 THEN 70\r\n        WHEN bu.price_momentum >= 25 THEN 55\r\n        WHEN bu.price_momentum >= 0 THEN 40\r\n        ELSE 20\r\n      END AS oneil_rs_score,\r\n\r\n      -- Volume Score\r\n      CASE\r\n        WHEN bu.volume_ratio >= 2.0 THEN 100\r\n        WHEN bu.volume_ratio >= p_oneil_volume_surge THEN 85\r\n        WHEN bu.volume_ratio >= 1.2 THEN 70\r\n        WHEN bu.volume_ratio >= 1.0 THEN 50\r\n        WHEN bu.volume_ratio >= 0.8 THEN 35\r\n        ELSE 20\r\n      END AS oneil_volume_score,\r\n\r\n      -- Momentum Score (price relative to 52w range)\r\n      CASE\r\n        WHEN bu.price_52w_high > 0 AND bu.price_52w_low > 0 THEN\r\n          GREATEST(0, LEAST(100,\r\n            ((bu.price_current - bu.price_52w_low) / NULLIF(bu.price_52w_high - bu.price_52w_low, 0)) * 100\r\n          ))\r\n        ELSE 50\r\n      END AS oneil_momentum_score,\r\n\r\n      -- EPS Acceleration Score (similar to EPS growth but momentum-focused)\r\n      CASE\r\n        WHEN bu.eps_growth_yoy IS NULL THEN 50\r\n        WHEN bu.eps_growth_yoy >= p_oneil_eps_accel_min * 2 THEN 100\r\n        WHEN bu.eps_growth_yoy >= p_oneil_eps_accel_min THEN 80\r\n        WHEN bu.eps_growth_yoy >= 10 THEN 60\r\n        WHEN bu.eps_growth_yoy >= 0 THEN 40\r\n        ELSE 20\r\n      END AS oneil_eps_accel_score,\r\n\r\n      -- ================================================================\r\n      -- GRAHAM SCORE (Deep Value + Safety)\r\n      -- ================================================================\r\n      -- P/B Score (lower is better for value)\r\n      CASE\r\n        WHEN bu.pb_ratio IS NULL THEN 50\r\n        WHEN bu.pb_ratio <= 1.0 THEN 100\r\n        WHEN bu.pb_ratio <= p_graham_pb_max THEN 85\r\n        WHEN bu.pb_ratio <= 2.0 THEN 70\r\n        WHEN bu.pb_ratio <= 3.0 THEN 50\r\n        ELSE GREATEST(0, 100 - (bu.pb_ratio * 15))\r\n      END AS graham_pb_score,\r\n\r\n      -- Current Ratio Score (higher is better for safety)\r\n      CASE\r\n        WHEN bu.current_ratio IS NULL THEN 50\r\n        WHEN bu.current_ratio >= 3.0 THEN 100\r\n        WHEN bu.current_ratio >= p_graham_current_ratio_min THEN 85\r\n        WHEN bu.current_ratio >= 1.5 THEN 70\r\n        WHEN bu.current_ratio >= 1.0 THEN 50\r\n        ELSE 25\r\n      END AS graham_current_ratio_score,\r\n\r\n      -- Debt Score (lower debt-to-equity is better)\r\n      CASE\r\n        WHEN bu.debt_to_equity IS NULL THEN 50\r\n        WHEN bu.debt_to_equity <= 0.3 THEN 100\r\n        WHEN bu.debt_to_equity <= p_graham_debt_equity_max THEN 85\r\n        WHEN bu.debt_to_equity <= 1.0 THEN 65\r\n        WHEN bu.debt_to_equity <= 2.0 THEN 40\r\n        ELSE 20\r\n      END AS graham_debt_score,\r\n\r\n      -- Stability Score (P/E based - moderate P/E preferred)\r\n      CASE\r\n        WHEN bu.pe_ratio IS NULL THEN 50\r\n        WHEN bu.pe_ratio <= 0 THEN 20 -- Negative earnings\r\n        WHEN bu.pe_ratio <= 10 THEN 90\r\n        WHEN bu.pe_ratio <= p_graham_pe_max THEN 80\r\n        WHEN bu.pe_ratio <= 20 THEN 65\r\n        WHEN bu.pe_ratio <= 30 THEN 45\r\n        ELSE GREATEST(0, 100 - (bu.pe_ratio * 2))\r\n      END AS graham_stability_score\r\n\r\n    FROM base_universe bu\r\n  ),\r\n\r\n  -- PASO 11: Calculate composite scores\r\n  final_scores AS (\r\n    SELECT\r\n      su.*,\r\n      -- Lynch composite (equal weight sub-scores)\r\n      (su.lynch_peg_score * 0.35 + su.lynch_roe_score * 0.25 +\r\n       su.lynch_eps_growth_score * 0.25 + su.lynch_revenue_growth_score * 0.15) AS lynch_score,\r\n\r\n      -- O'Neil composite\r\n      (su.oneil_rs_score * 0.30 + su.oneil_volume_score * 0.20 +\r\n       su.oneil_momentum_score * 0.25 + su.oneil_eps_accel_score * 0.25) AS oneil_score,\r\n\r\n      -- Graham composite\r\n      (su.graham_pb_score * 0.30 + su.graham_current_ratio_score * 0.25 +\r\n       su.graham_debt_score * 0.25 + su.graham_stability_score * 0.20) AS graham_score\r\n    FROM scored_universe su\r\n  ),\r\n\r\n  -- PASO 12: Calculate Trinity score and generate signals\r\n  signals AS (\r\n    SELECT\r\n      fs.*,\r\n      -- Trinity Score = Lynch(35%) + O'Neil(35%) + Graham(30%)\r\n      (fs.lynch_score * p_lynch_weight +\r\n       fs.oneil_score * p_oneil_weight +\r\n       fs.graham_score * p_graham_weight) AS trinity_score\r\n    FROM final_scores fs\r\n  ),\r\n\r\n  -- PASO 13: Rank and assign signals\r\n  ranked_signals AS (\r\n    SELECT\r\n      s.*,\r\n      ROW_NUMBER() OVER (ORDER BY s.trinity_score DESC) AS ranking_position,\r\n      PERCENT_RANK() OVER (ORDER BY s.trinity_score) * 100 AS percentile_rank,\r\n      -- Signal strength\r\n      CASE\r\n        WHEN s.trinity_score >= p_strong_buy_threshold THEN 'STRONG BUY'\r\n        WHEN s.trinity_score >= p_buy_threshold THEN 'BUY'\r\n        WHEN s.trinity_score >= p_hold_threshold THEN 'HOLD'\r\n        ELSE 'SELL'\r\n      END AS signal_strength,\r\n      -- Recommendation\r\n      CASE\r\n        WHEN s.trinity_score >= p_strong_buy_threshold THEN 'Aggressive accumulation recommended'\r\n        WHEN s.trinity_score >= p_buy_threshold THEN 'Consider buying on pullback'\r\n        WHEN s.trinity_score >= p_hold_threshold THEN 'Hold current position'\r\n        ELSE 'Consider reducing position'\r\n      END AS recommendation,\r\n      -- Confidence level (based on data quality and score clarity)\r\n      LEAST(100, s.data_quality_score * 100 +\r\n            ABS(s.trinity_score - p_hold_threshold) * 0.5) AS confidence_level,\r\n      -- Entry price (current price)\r\n      s.price_current AS entry_price,\r\n      -- Stop loss\r\n      s.price_current * (1 - p_stop_loss_pct / 100) AS stop_loss,\r\n      -- Target price\r\n      s.price_current * (1 + p_target_pct / 100) AS target_price,\r\n      -- Risk/Reward ratio\r\n      (p_target_pct / p_stop_loss_pct) AS risk_reward_ratio,\r\n      -- Has complete data flag\r\n      CASE\r\n        WHEN s.eps_ttm IS NOT NULL\r\n         AND s.pe_ratio IS NOT NULL\r\n         AND s.roe IS NOT NULL\r\n        THEN TRUE\r\n        ELSE FALSE\r\n      END AS has_complete_data\r\n    FROM signals s\r\n  )\r\n\r\n  -- Final SELECT for INSERT\r\n  SELECT\r\n    ticker,\r\n    ticker_norm,\r\n    company_name,\r\n    sector,\r\n    industry,\r\n    signal_date,\r\n    price_current,\r\n    price_52w_high,\r\n    price_52w_low,\r\n    CAST(volume_daily AS INT64) AS volume_daily,\r\n    volume_avg_50d,\r\n    market_cap,\r\n    eps_ttm,\r\n    revenues_ttm,\r\n    net_income_ttm,\r\n    stockholders_equity,\r\n    current_assets,\r\n    current_liabilities,\r\n    long_term_debt,\r\n    roe,\r\n    current_ratio,\r\n    revenue_growth_yoy,\r\n    eps_growth_yoy,\r\n    net_income_growth_yoy,\r\n    pe_ratio,\r\n    pb_ratio,\r\n    ps_ratio,\r\n    peg_ratio,\r\n    debt_to_equity,\r\n    lynch_score,\r\n    lynch_peg_score,\r\n    lynch_roe_score,\r\n    lynch_eps_growth_score,\r\n    lynch_revenue_growth_score,\r\n    oneil_score,\r\n    oneil_rs_score,\r\n    oneil_volume_score,\r\n    oneil_momentum_score,\r\n    oneil_eps_accel_score,\r\n    graham_score,\r\n    graham_pb_score,\r\n    graham_current_ratio_score,\r\n    graham_debt_score,\r\n    graham_stability_score,\r\n    trinity_score,\r\n    signal_strength,\r\n    recommendation,\r\n    confidence_level,\r\n    entry_price,\r\n    stop_loss,\r\n    target_price,\r\n    risk_reward_ratio,\r\n    CAST(ranking_position AS INT64) AS ranking_position,\r\n    percentile_rank,\r\n    data_quality_score,\r\n    has_complete_data,\r\n    v_execution_ts AS calculation_timestamp,\r\n    v_current_regime AS market_regime\r\n  FROM ranked_signals;\r\n\r\n  -- ========================================================================\r\n  -- PASO 14: CLEANUP OLD PARTITIONS (>7 days)\r\n  -- ========================================================================\r\n  DELETE FROM `sunny-advantage-471523-b3.IS_Fundamentales.trinity_signals_daily`\r\n  WHERE signal_date < DATE_SUB(execution_date, INTERVAL 7 DAY);\r\n\r\nEND"
}